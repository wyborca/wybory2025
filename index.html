<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Analiza komisji wyborczych</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.1/css/dataTables.dataTables.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/4.0.0/css/fixedHeader.dataTables.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .danger { background-color: #ffe5e5 !important; }
        .warning { background-color: #fff9e5 !important; }
        .ok { background-color: #e5ffe5 !important; }
        .details-grid {
            font-size: 0.8rem;
        }
        .details-heading {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .details-table {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 4px 16px;
            font-family: sans-serif;
        }
        .details-table dt {
            font-weight: bold;
            text-align: right;
            color: #333;
        }
        .details-table dd {
            margin: 0;
            text-align: left;
            color: #000;
        }
        p {
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body>
<section class="container my-4">
    <h2 class="mb-3">üïµÔ∏è‚Äç‚ôÇÔ∏è Analiza danych wyborczych ‚Äì czy wszystko siƒô zgadza?</h2>
    <p>
        Na podstawie wynik√≥w z I i II tury wybor√≥w prezydenckich oraz danych sonda≈ºowych dotyczƒÖcych
        <strong>przep≈Çyw√≥w elektoratu</strong>, opracowali≈õmy wska≈∫nik pozwalajƒÖcy wychwyciƒá
        <strong>komisje wyborcze o nietypowych wynikach</strong>. Ten wska≈∫nik ‚Äì
        <code>alert_index</code> ‚Äì pokazuje, o ile procent <strong>rzeczywisty wynik</strong>
        Rafa≈Ça Trzaskowskiego w II turze r√≥≈ºni siƒô od <strong>oczekiwanej liczby g≈Ços√≥w</strong>.

        Szacowana liczba g≈Ços√≥w na Trzaskowskiego obliczana jest wed≈Çug wzoru:

    <pre><code>
    oczekiwana_liczba = (g≈Çosy_w_II_turze / g≈Çosy_w_I_turze) √ó ‚àë (g≈Çosy_kandydata_z_I_tury √ó wska≈∫nik_przep≈Çywu)
    </code></pre>

    Gdzie:
    <ul>
        <li><strong>skala g≈ÇosujƒÖcych</strong> to stosunek liczby wydanych kart w II turze do liczby kart wydanych w I turze,</li>
        <li><strong>wska≈∫nik przep≈Çywu</strong> to szacowane prawdopodobie≈Ñstwo, ≈ºe wyborca danego kandydata z I tury odda g≈Ços na Trzaskowskiego w turze drugiej.</li>
    </ul>
    Dziƒôki temu podej≈õciu uwzglƒôdniamy r√≥wnie≈º sytuacje, w kt√≥rych liczba uprawnionych do g≈Çosowania wzros≈Ça ‚Äì na przyk≈Çad z powodu dopisania do spisu wyborc√≥w przebywajƒÖcych czasowo, jak wczasowicze czy pensjonariusze DPS-√≥w.
    </p>

    <h3 class="mt-4">üßÆ Macierz przep≈Çyw√≥w elektoratu</h3>
    <p>
        Do obliczenia oczekiwanych wynik√≥w w II turze wykorzystali≈õmy nastƒôpujƒÖcƒÖ macierz przep≈Çywu g≈Ços√≥w
        (prawdopodobie≈Ñstwo oddania g≈Çosu na Trzaskowskiego w II turze przez wyborcƒô danego kandydata z I tury):
    </p>
    <div class="table-responsive">
        <table class="table table-bordered table-sm w-auto">
            <thead class="table-light">
            <tr>
                <th>Kandydat (I tura)</th>
                <th>% wyborc√≥w g≈ÇosujƒÖcych na Nawrockiego w II turze</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>MENTZEN</td><td>88,1%</td></tr>
            <tr><td>BRAUN</td><td>92,5%</td></tr>
            <tr><td>HO≈ÅOWNIA</td><td>13,8%</td></tr>
            <tr><td>ZANDBERG</td><td>16,2%</td></tr>
            <tr><td>BIEJAT</td><td>9,8%</td></tr>
            <tr><td>SENYSZYN</td><td>18,9%</td></tr>
            <tr><td>STANOWSKI</td><td>51,2%</td></tr>
            <tr><td>TRZASKOWSKI</td><td>0.1%</td></tr>
            <tr><td>NAWROCKI</td><td>99,3%</td></tr>
            </tbody>
        </table>
    </div>

    <h3 class="mt-4">üßì Domy Pomocy Spo≈Çecznej pod lupƒÖ</h3>
    <p>
        Analiza ujawni≈Ça niepokojƒÖcƒÖ zale≈ºno≈õƒá ‚Äì <strong>w≈õr√≥d komisji z najwy≈ºszym alertem</strong> istotnƒÖ czƒô≈õƒá stanowiƒÖ te zlokalizowane w Domach Pomocy Spo≈Çecznej (DPS). Przyk≈Çad stanowi:
    </p>
    <ul>
        <li>
            <strong>DPS w Mianocicach</strong> (woj. ma≈Çopolskie), gdzie w I turze zag≈Çosowa≈Ço <strong>15 os√≥b</strong>, w tym m.in.:
            <ul>
                <li>4 na Biejat</li>
                <li>1 na Trzaskowskiego</li>
                <li>2 na Maciaka</li>
                <li>2 na Mentzena</li>
            </ul>
        </li>
        <li>
            W II turze frekwencja wzros≈Ça ponad dwukrotnie ‚Äì zag≈Çosowa≈Çy <strong>32 osoby</strong>, co samo w sobie jest nietypowe.
        </li>
        <li>
            Trzaskowski uzyska≈Ç jedynie <strong>4 g≈Çosy</strong>, mimo ≈ºe model przep≈Çyw√≥w wskazywa≈Ç, ≈ºe powinien zdobyƒá co najmniej <strong>5</strong>. To oznacza, ≈ºe nawet jego pierwotni wyborcy nie zag≈Çosowali na niego ponownie.
        </li>
        <li>
            Nawrocki zdoby≈Ç a≈º <strong>27 g≈Ços√≥w</strong>, co znaczƒÖco przekracza prognozy wynikajƒÖce z I tury.
        </li>
    </ul>
    <p>
        Tak znaczƒÖce r√≥≈ºnice mogƒÖ ≈õwiadczyƒá o nietypowej mobilizacji w II turze. Potencjalne przyczyny to:
    </p>
    <ul>
        <li>g≈Çosowanie zorganizowane przez osoby trzecie,</li>
        <li>udzia≈Ç os√≥b zameldowanych, ale niezamieszkujƒÖcych na sta≈Çe,</li>
        <li>inne formy zewnƒôtrznej ingerencji w proces wyborczy.</li>
    </ul>
    </section>

    <h3 class="mt-4">üìò Legenda kolumn</h3>
    <ul>
        <li><strong>Nr komisji</strong> ‚Äì z protoko≈Ç√≥w PKW</li>
        <li><strong>Gmina</strong> ‚Äì z protoko≈Ç√≥w PKW</li>
        <li><strong>Powiat</strong> ‚Äì z protoko≈Ç√≥w PKW</li>
        <li><strong>Wojew√≥dztwo</strong> ‚Äì z protoko≈Ç√≥w PKW</li>
        <li><strong>Typ obwodu</strong> ‚Äì z protoko≈Ç√≥w PKW</li>
        <li><strong>Frekwencja I</strong> ‚Äì Frekwencja procentowa I tura, w nawiasie zaznaczono ile wydano kart spo≈õr√≥d uprawnionych</li>
        <li><strong>Frekwencja II</strong> ‚Äì Frekwencja procentowa II tura, w nawiasie zaznaczono ile wydano kart spo≈õr√≥d uprawnionych</li>
        <li><strong>Trzaskowski I</strong> ‚Äì Ilo≈õƒá g≈Ços√≥w na Trzaskowskiego w I turze</li>
        <li><strong>Oczekiwania T</strong> ‚Äì Przewidywana ilo≈õƒá g≈Ços√≥w na Trzaskowskiego obliczona wg wzoru powy≈ºej</li>
        <li><strong>Trzaskowski II</strong> ‚Äì Ilo≈õƒá g≈Ços√≥w na Trzaskowskiego w II turze</li>
        <li><strong>Nawrocki I</strong> ‚Äì Ilo≈õƒá g≈Ços√≥w na Nawrockiego w I turze</li>
        <li><strong>Oczekiwania N</strong> ‚Äì Przewidywana ilo≈õƒá g≈Ços√≥w na Nawrockiego obliczona wg wzoru powy≈ºej</li>
        <li><strong>Nawrocki II</strong> ‚Äì Ilo≈õƒá g≈Ços√≥w na Nawrockiego w II turze</li>
        <li><strong>Zmiana T.</strong> ‚Äì procentowa zmiana Trzaskowskiego I do II tury</li>
        <li><strong>Zmiana N.</strong> ‚Äì procentowa zmiana Nawrockiego I do II tury</li>
        <li><strong>Delta T.</strong> ‚Äì rzeczywiste g≈Çosy Trzaskowskiego w II turze minus oczekiwane g≈Çosy Trzaskowskiego</li>
        <li><strong>Delta N.</strong> ‚Äì rzeczywiste g≈Çosy Nawrockiego w II turze minus oczekiwane g≈Çosy Nawrockiego</li>
        <li><strong>Alert Index</strong> ‚Äì procentowa r√≥≈ºnica pomiƒôdzy Oczekiwaniami T a Trzaskowskim II</li>
        <li><strong>‚ÑπÔ∏è Klikniƒôcie na strza≈Çkƒô przy numerze komisji</strong> ‚Äì pokazuje dodatkowe szczeg√≥≈Çy na temat danej komisji, w tym wyniki szczeg√≥≈Çowe z I tury.</li>
    </ul>

<table id="results" class="display" style="width:100%">
    <thead>
    <tr>
        <th>Nr komisji</th>
        <th>Gmina</th>
        <th>Powiat</th>
        <th>Wojew√≥dztwo</th>
        <th>Typ obwodu</th>
        <th>Frekwencja I</th>
        <th>Frekwencja II</th>
        <th>Trzaskowski I</th>
        <th>Oczekiwania T.</th>
        <th>Trzaskowski II</th>
        <th>Nawrocki I</th>
        <th>Oczekiwania N.</th>
        <th>Nawrocki II</th>
        <th>Zmiana T. (%)</th>
        <th>Zmiana N. (%)</th>
        <th>Delta T. (%)</th>
        <th>Delta N. (%)</th>
        <th>Alert index (%)</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/2.3.1/js/dataTables.js"></script>

<script>
    const mappedColumns = [
        row => row.commission["Nr komisji"],
        row => row.commission["Gmina"],
        row => row.commission["Powiat"],
        row => row.commission["Wojew√≥dztwo"],
        row => row.commission["Typ obwodu"],
        row => row.turnout.first,
        row => row.turnout.second,
        row => row.first_round["TRZASKOWSKI Rafa≈Ç Kazimierz_1"],
        row => row.calculations["expected_trzaskowski"],
        row => row.second_round["TRZASKOWSKI Rafa≈Ç Kazimierz_2"],
        row => row.first_round["NAWROCKI Karol Tadeusz_1"],
        row => row.calculations["expected_nawrocki"],
        row => row.second_round["NAWROCKI Karol Tadeusz_2"],
        row => row.calculations["change_TRZASKOWSKI Rafa≈Ç Kazimierz_pct"].toFixed(2),
        row => row.calculations["change_NAWROCKI Karol Tadeusz_pct"].toFixed(2),
        row => row.calculations["delta_trzaskowski"].toFixed(2),
        row => row.calculations["delta_nawrocki"].toFixed(2),
        row => row.calculations["alert_index_pct"].toFixed(2)
    ];

    function formatDetails(row) {
        return `
    <div class="details-grid">
        <h4 class="details-heading">Dane komisji:</h4>
        <p><strong>Siedziba:</strong> ${row.commission["Siedziba"]}</p>
        <p><strong>Typ obwodu:</strong> ${row.commission["Typ obwodu"]}</p>
        <p><strong>Typ obszaru:</strong> ${row.commission["Typ obszaru"]}</p>
        <p><strong>Teryt Gminy:</strong> ${row.commission["Teryt Gminy"]}</p>
        <p><strong>Teryt Powiatu:</strong> ${row.commission["Teryt Powiatu"]}</p>
        <h4 class="details-heading">Wyniki I tury</h4>
        <dl class="details-table">
            <dt>BIEJAT</dt><dd>${row.first_round["BIEJAT Magdalena Agnieszka_1"]}</dd>
            <dt>TRZASKOWSKI</dt><dd>${row.first_round["TRZASKOWSKI Rafa≈Ç Kazimierz_1"]}</dd>
            <dt>HO≈ÅOWNIA</dt><dd>${row.first_round["HO≈ÅOWNIA Szymon Franciszek_1"]}</dd>
            <dt>SENYSZYN</dt><dd>${row.first_round["SENYSZYN Joanna_1"]}</dd>
            <dt>ZANDBERG</dt><dd>${row.first_round["ZANDBERG Adrian Tadeusz_1"]}</dd>
            <dt>BARTOSZEWICZ</dt><dd>${row.first_round["BARTOSZEWICZ Artur_1"]}</dd>
            <dt>BRAUN</dt><dd>${row.first_round["BRAUN Grzegorz Micha≈Ç_1"]}</dd>
            <dt>JAKUBIAK</dt><dd>${row.first_round["JAKUBIAK Marek_1"]}</dd>
            <dt>MACIAK</dt><dd>${row.first_round["MACIAK Maciej_1"]}</dd>
            <dt>MENTZEN</dt><dd>${row.first_round["MENTZEN S≈Çawomir Jerzy_1"]}</dd>
            <dt>NAWROCKI</dt><dd>${row.first_round["NAWROCKI Karol Tadeusz_1"]}</dd>
            <dt>STANOWSKI</dt><dd>${row.first_round["STANOWSKI Krzysztof Jakub_1"]}</dd>
            <dt>WOCH</dt><dd>${row.first_round["WOCH Marek Marian_1"]}</dd>
        </dl>
    </div>`;
    }

    let currentData = [];

    $(document).ready(function () {
        const table = $('#results').DataTable({
            language: {
                url: "https://cdn.datatables.net/plug-ins/2.3.1/i18n/pl.json"
            },
            fixedHeader: true,
            columns: [
                {
                    className: 'dt-control',
                    orderable: false,
                    data: null,
                    defaultContent: '',
                    title: '',
                },
                { title: "Nr komisji" },
                { title: "Gmina" },
                { title: "Powiat" },
                { title: "Wojew√≥dztwo" },
                { title: "Typ obwodu" },
                { title: "Frekwencja I" },
                { title: "Frekwencja II" },
                { title: "Trzaskowski I" },
                { title: "Oczekiwania T" },
                { title: "Trzaskowski II" },
                { title: "Nawrocki I" },
                { title: "Oczekiwania N" },
                { title: "Nawrocki II" },
                { title: "Zmiana T. (%)" },
                { title: "Zmiana N. (%)" },
                { title: "Delta T. (%)" },
                { title: "Delta N. (%)" },
                { title: "Alert index (%)" },
            ],
            searching: false,
            ordering: false,
            serverSide: true,
            ajax: function (data, callback) {
                if (typeof data.start === 'undefined') {
                    data.start = 0;
                }
                if (typeof data.length === 'undefined') {
                    data.length = 10;
                }
                let page = Math.floor(data.start / data.length) + 1;
                fetch(`/wybory2025/data/${data.length}/page_${page}.json`)
                    .then(res => res.json())
                    .then(json => {
                        currentData = json;
                        const rows = json.map(row => [''].concat(mappedColumns.map(fn => fn(row))));
                        callback({
                            draw: data.draw,
                            recordsTotal: 32057,
                            recordsFiltered: 32057,
                            data: rows
                        });
                    });
            },
            createdRow: function (row, data, dataIndex, cells) {
                const alert = parseFloat(data[18]);
                if (alert > 90) {
                    $(row).addClass('danger');
                } else if (alert > 70) {
                    $(row).addClass('warning');
                } else {
                    $(row).addClass('ok');
                }

                // Highlight Domy Pomocy Spo≈Çecznej
                const type = data[5].toLowerCase();
                if (type.includes('dom pomocy spo≈Çecznej') || type.includes('zak≈Çad leczniczy')) {
                    $(cells[5]).css('background-color', '#f8d7da'); // Bootstrap danger background
                    $(cells[5]).css('font-weight', 'bold');
                    $(cells[5]).css('color', '#721c24');
                }
            }
        });

        $('#results tbody').on('click', 'td.dt-control', function () {
            const tr = $(this).closest('tr');
            const row = table.row(tr);
            const rowIndex = tr.index();
            const realRow = currentData[rowIndex];
            if (row.child.isShown()) {
                row.child.hide();
                tr.removeClass('shown');
            } else {
                row.child(formatDetails(realRow)).show();
                tr.addClass('shown');
            }
        });
    });
</script>
<script src="https://cdn.datatables.net/fixedheader/4.0.0/js/dataTables.fixedHeader.min.js"></script>
</body>
</html>
